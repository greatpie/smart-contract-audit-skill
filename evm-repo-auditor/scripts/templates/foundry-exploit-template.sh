#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="${REPO_DIR:-${AUDIT_REPO_DIR:-}}"
RPC_URL="${RPC_URL:-}"
ATTACKER_PK="${ATTACKER_PK:-}"

if [ -z "$REPO_DIR" ] || [ ! -d "$REPO_DIR" ]; then
  echo "[ERROR] REPO_DIR is not set or does not exist." >&2
  exit 1
fi

if ! command -v forge >/dev/null 2>&1; then
  cat <<EOF
[WARN] forge is not installed. Skipping Foundry exploit run.
[INFO] Install Foundry and rerun with:
  bash scripts/run_exploit.sh --repo-dir "$REPO_DIR" --template foundry
EOF
  exit 0
fi

if [ -z "$RPC_URL" ] || [ -z "$ATTACKER_PK" ]; then
  cat <<EOF
[ERROR] Missing RPC_URL or ATTACKER_PK.
[INFO] Source exploit env first:
  source "$REPO_DIR/submission/exploit-env.sh"
EOF
  exit 1
fi

SCRIPT_TARGET="${FOUNDRY_EXPLOIT_SCRIPT:-}"
if [ -z "$SCRIPT_TARGET" ]; then
  for candidate in \
    "script/Exploit.s.sol:ExploitScript" \
    "script/Poc.s.sol:PocScript" \
    "script/PoC.s.sol:PoCScript" \
    "script/Attack.s.sol:AttackScript"; do
    script_file="${candidate%%:*}"
    if [ -f "$REPO_DIR/$script_file" ]; then
      SCRIPT_TARGET="$candidate"
      break
    fi
  done
fi

if [ -z "$SCRIPT_TARGET" ]; then
  if [ -n "${SKILL_SCRIPTS_DIR:-}" ] && [ -x "${SKILL_SCRIPTS_DIR}/generate_exploit_scaffold.sh" ]; then
    "${SKILL_SCRIPTS_DIR}/generate_exploit_scaffold.sh" --repo-dir "$REPO_DIR" --framework foundry
    SCRIPT_TARGET="script/Exploit.s.sol:ExploitScript"
  fi
fi

if [ -z "$SCRIPT_TARGET" ]; then
  cat > "$REPO_DIR/submission/foundry-exploit-template.todo.md" <<'EOF'
# Foundry Exploit Template TODO

No exploit script was found automatically.

Create one of the following scripts:
- `script/Exploit.s.sol` with contract `ExploitScript`
- `script/Poc.s.sol` with contract `PocScript`
- `script/Attack.s.sol` with contract `AttackScript`

Then rerun:

```bash
bash scripts/run_exploit.sh --repo-dir <repo> --template foundry
```

Or specify custom target:

```bash
FOUNDRY_EXPLOIT_SCRIPT="script/MyExploit.s.sol:MyExploitScript" \
bash scripts/run_exploit.sh --repo-dir <repo> --template foundry
```
EOF
  echo "[WARN] No Foundry exploit script found. Wrote TODO to submission/foundry-exploit-template.todo.md"
  exit 0
fi

cd "$REPO_DIR"
echo "[INFO] Running Foundry exploit script: $SCRIPT_TARGET"
forge script "$SCRIPT_TARGET" \
  --rpc-url "$RPC_URL" \
  --private-key "$ATTACKER_PK" \
  --broadcast \
  -vvv

echo "[INFO] Foundry exploit template completed."
