#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib.sh"

usage() {
  cat <<'EOF'
Usage:
  bash scripts/run_exploit.sh --repo-dir <path> [options]

Options:
  --repo-dir <path>      Target repository path (required)
  --port <n>             Anvil RPC port (default: 8756)
  --chain-id <n>         Chain ID (default: 31337)
  --tx-script <path>     Optional transaction script to run after startup
  --template <name>      Built-in tx template: foundry|hardhat
  --stop                 Stop existing Anvil process for this repo and exit
  --help                 Show this message
EOF
}

REPO_DIR=""
PORT="8756"
CHAIN_ID="31337"
TX_SCRIPT=""
TEMPLATE=""
STOP_ONLY="0"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --repo-dir)
      REPO_DIR="${2:-}"
      shift 2
      ;;
    --port)
      PORT="${2:-}"
      shift 2
      ;;
    --chain-id)
      CHAIN_ID="${2:-}"
      shift 2
      ;;
    --tx-script)
      TX_SCRIPT="${2:-}"
      shift 2
      ;;
    --template)
      TEMPLATE="${2:-}"
      shift 2
      ;;
    --stop)
      STOP_ONLY="1"
      shift
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      die "Unknown argument: $1"
      ;;
  esac
done

[ -n "$REPO_DIR" ] || {
  usage
  die "--repo-dir is required"
}

REPO_DIR="$(abs_path "$REPO_DIR")"
[ -d "$REPO_DIR" ] || die "Repo path does not exist: $REPO_DIR"

ENV_FILE="$REPO_DIR/.audit-meta/env.sh"
[ -f "$ENV_FILE" ] || die "Missing bootstrap metadata: $ENV_FILE. Run scripts/bootstrap.sh first."
source "$ENV_FILE"

mkdir -p "$AUDIT_META_DIR" "$AUDIT_SUBMISSION_DIR" "$AUDIT_LOG_DIR"

PID_FILE="$AUDIT_META_DIR/anvil.pid"
ANVIL_LOG="$AUDIT_LOG_DIR/anvil.log"
RPC_URL="http://127.0.0.1:$PORT"

if [ "$STOP_ONLY" = "1" ]; then
  if [ -f "$PID_FILE" ]; then
    PID="$(cat "$PID_FILE")"
    if kill -0 "$PID" >/dev/null 2>&1; then
      kill "$PID"
      log "Stopped Anvil process $PID"
    else
      warn "Anvil PID file exists, but process is not running."
    fi
    rm -f "$PID_FILE"
  else
    warn "No Anvil PID file found."
  fi
  exit 0
fi

require_cmd anvil

if [ -f "$PID_FILE" ]; then
  EXISTING_PID="$(cat "$PID_FILE")"
  if kill -0 "$EXISTING_PID" >/dev/null 2>&1; then
    log "Anvil already running (PID $EXISTING_PID) at $RPC_URL"
  else
    warn "Removing stale PID file."
    rm -f "$PID_FILE"
  fi
fi

if [ ! -f "$PID_FILE" ]; then
  log "Starting Anvil on $RPC_URL (chain-id=$CHAIN_ID)"
  anvil \
    --host 127.0.0.1 \
    --port "$PORT" \
    --chain-id "$CHAIN_ID" \
    --mnemonic "test test test test test test test test test test test junk" \
    > "$ANVIL_LOG" 2>&1 &

  ANVIL_PID="$!"
  echo "$ANVIL_PID" > "$PID_FILE"
  sleep 1
  if ! kill -0 "$ANVIL_PID" >/dev/null 2>&1; then
    rm -f "$PID_FILE"
    die "Failed to start Anvil. See $ANVIL_LOG"
  fi
fi

ATTACKER_PK="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
ATTACKER_ADDRESS="0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266"

EXPLOIT_ENV="$AUDIT_SUBMISSION_DIR/exploit-env.sh"
{
  printf 'export RPC_URL=%q\n' "$RPC_URL"
  printf 'export CHAIN_ID=%q\n' "$CHAIN_ID"
  printf 'export ATTACKER_PK=%q\n' "$ATTACKER_PK"
  printf 'export ATTACKER_ADDRESS=%q\n' "$ATTACKER_ADDRESS"
} > "$EXPLOIT_ENV"

  if [ -n "$TX_SCRIPT" ]; then
    TX_SCRIPT="$(abs_path "$TX_SCRIPT")"
    [ -f "$TX_SCRIPT" ] || die "tx script not found: $TX_SCRIPT"
    log "Running tx script: $TX_SCRIPT"
    RPC_URL="$RPC_URL" CHAIN_ID="$CHAIN_ID" ATTACKER_PK="$ATTACKER_PK" ATTACKER_ADDRESS="$ATTACKER_ADDRESS" \
    REPO_DIR="$AUDIT_REPO_DIR" FRAMEWORK="$AUDIT_FRAMEWORK" \
    bash "$TX_SCRIPT" > "$AUDIT_LOG_DIR/exploit-script.log" 2>&1
elif [ -n "$TEMPLATE" ]; then
  case "$TEMPLATE" in
    foundry)
      TX_SCRIPT="$SCRIPT_DIR/templates/foundry-exploit-template.sh"
      ;;
    hardhat)
      TX_SCRIPT="$SCRIPT_DIR/templates/hardhat-exploit-template.sh"
      ;;
    *)
      die "Unknown template: $TEMPLATE (expected foundry|hardhat)"
      ;;
  esac
  log "Running built-in exploit template: $TEMPLATE"
  RPC_URL="$RPC_URL" CHAIN_ID="$CHAIN_ID" ATTACKER_PK="$ATTACKER_PK" ATTACKER_ADDRESS="$ATTACKER_ADDRESS" \
    REPO_DIR="$AUDIT_REPO_DIR" FRAMEWORK="$AUDIT_FRAMEWORK" SKILL_SCRIPTS_DIR="$SCRIPT_DIR" \
    bash "$TX_SCRIPT" > "$AUDIT_LOG_DIR/exploit-script.log" 2>&1
fi

TXS_MD="$AUDIT_SUBMISSION_DIR/txs.md"
cat > "$TXS_MD" <<EOF
# Exploit Transaction Log

- RPC URL: \`$RPC_URL\`
- Chain ID: \`$CHAIN_ID\`
- Attacker address: \`$ATTACKER_ADDRESS\`
- Started at: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`

## Transactions

1. TODO

## Balance / State Evidence

- Before: TODO
- After: TODO
- Relevant events: TODO
EOF

TXS_JSON="$AUDIT_SUBMISSION_DIR/txs.json"
cat > "$TXS_JSON" <<'EOF'
[]
EOF

log "Exploit environment ready."
log "Source env with: source $EXPLOIT_ENV"
