#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="${REPO_DIR:-${AUDIT_REPO_DIR:-}}"
RPC_URL="${RPC_URL:-}"
CHAIN_ID="${CHAIN_ID:-31337}"
ATTACKER_PK="${ATTACKER_PK:-}"

if [ -z "$REPO_DIR" ] || [ ! -d "$REPO_DIR" ]; then
  echo "[ERROR] REPO_DIR is not set or does not exist." >&2
  exit 1
fi

if ! command -v npx >/dev/null 2>&1; then
  cat <<EOF
[WARN] npx is not available. Skipping Hardhat exploit run.
[INFO] Install Node.js/npm and rerun with:
  bash scripts/run_exploit.sh --repo-dir "$REPO_DIR" --template hardhat
EOF
  exit 0
fi

if [ -z "$RPC_URL" ] || [ -z "$ATTACKER_PK" ]; then
  cat <<EOF
[ERROR] Missing RPC_URL or ATTACKER_PK.
[INFO] Source exploit env first:
  source "$REPO_DIR/submission/exploit-env.sh"
EOF
  exit 1
fi

ENTRY="${HARDHAT_EXPLOIT_ENTRY:-}"
if [ -z "$ENTRY" ]; then
  for candidate in \
    "scripts/exploit.ts" \
    "scripts/exploit.js" \
    "scripts/poc.ts" \
    "scripts/poc.js" \
    "scripts/attack.ts" \
    "scripts/attack.js"; do
    if [ -f "$REPO_DIR/$candidate" ]; then
      ENTRY="$candidate"
      break
    fi
  done
fi

if [ -z "$ENTRY" ] && [ -z "${HARDHAT_EXPLOIT_CMD:-}" ]; then
  if [ -n "${SKILL_SCRIPTS_DIR:-}" ] && [ -x "${SKILL_SCRIPTS_DIR}/generate_exploit_scaffold.sh" ]; then
    "${SKILL_SCRIPTS_DIR}/generate_exploit_scaffold.sh" --repo-dir "$REPO_DIR" --framework hardhat
    ENTRY="scripts/exploit.js"
  fi
fi

if [ -z "$ENTRY" ] && [ -z "${HARDHAT_EXPLOIT_CMD:-}" ]; then
  cat > "$REPO_DIR/submission/hardhat-exploit-template.todo.md" <<'EOF'
# Hardhat Exploit Template TODO

No exploit script was found automatically.

Add one of the following files:
- `scripts/exploit.ts` / `scripts/exploit.js`
- `scripts/poc.ts` / `scripts/poc.js`
- `scripts/attack.ts` / `scripts/attack.js`

Then rerun:

```bash
bash scripts/run_exploit.sh --repo-dir /Users/pie/Projects/temp/smartcontract-audit-skill --template hardhat
```

You can also run a custom command:

```bash
HARDHAT_EXPLOIT_CMD="npx hardhat run scripts/my-exploit.ts --network localhost" \
bash scripts/run_exploit.sh --repo-dir /Users/pie/Projects/temp/smartcontract-audit-skill --template hardhat
```
EOF
  echo "[WARN] No Hardhat exploit entry found. Wrote TODO to submission/hardhat-exploit-template.todo.md"
  exit 0
fi

cd "$REPO_DIR"
export PRIVATE_KEY="$ATTACKER_PK"
export EXPLOIT_PRIVATE_KEY="$ATTACKER_PK"
export RPC_URL="$RPC_URL"
export CHAIN_ID="$CHAIN_ID"

if [ -n "${HARDHAT_EXPLOIT_CMD:-}" ]; then
  echo "[INFO] Running custom Hardhat exploit command"
  bash -lc "$HARDHAT_EXPLOIT_CMD"
else
  echo "[INFO] Running Hardhat exploit entry: $ENTRY"
  npx hardhat run "$ENTRY" --network localhost
fi

echo "[INFO] Hardhat exploit template completed."
